<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><%- title %></title>
    <base href="/">
    <link href="/css/general.css" rel="stylesheet" type="text/css"/>
    <link href="/css/projectInfo.css" rel="stylesheet" type="text/css"/>
    <link href="/fontawesome/css/all.min.css" rel="stylesheet" type="text/css"/>
    <script src="/lib/lz-string.min.js"></script>
    <script src="/lib/angular.min.js"></script>
    <script>
        var app = angular.module("dashboard",[]);
        app.config(function($locationProvider){
            $locationProvider.html5Mode(true);
        });
    </script>
    <script src="/js/general.js"></script>
    <script src="/js/doc.js"></script>
    <script src="/js/dataManager.js"></script>
    <script src="/js/projectFilter.js"></script>
    <script src="/js/taskInfoCon.js"></script>
</head>
<style>
    ul{
        margin-left:2rem;
    }
</style>
<body ng-app="dashboard"
      ng-controller="rootCon">
<info-receiver  ng-init="user = '<%= encodeURIComponent(JSON.stringify(user)) %>';
                         createdAt = '<%= encodeURIComponent(JSON.stringify(createdAt)) %>';
                         id = '<%- id %>';
                         status = '<%- status %>';
                         schedule = '<%= encodeURIComponent(JSON.stringify(schedule)) %>'"></info-receiver>
<div id="header">
    <div id="headerButtons">
        <a href="/account" target="_blank">ACCOUNT</a>
        <a href="/tutorial" target="_blank">REFERENCE</a>
    </div>
</div>
<div id="statusBar" style="display:flex;flex-direction:row;">
    <a href="/tasks" target="_self" style="margin-right:0.5rem;">BACK</a>
    <span> >  Created On {{ create | date:'&y/&m/&d'}} by <%- submitter.name %></span>
    <button style="margin-left:auto;margin-right:0.5rem;" ng-disabled="taskUpdating || task.status>=4"  ng-click="pendTask()">HANG</button>
    <button ng-disabled="taskUpdating" ng-click="closeTask()">{{ task.status | buttonStatus}}</button>
    <button style="margin-left:0.5rem;margin-right:2rem;" ng-disabled="taskUpdating">LINK</button>
</div>
<div class="mainContents" id="mainContents_0" style="display:flex;flex-direction:column;" ng-controller="infoCon">
    <div style="font-size:1.5rem;font-weight:bold;"><%- title %></div>
<!--    关联Task-->
    <div style="display:flex;flex-direction:column;margin-bottom:0.5rem;">
        <div style="display:flex;flex-direction:row;"></div>
        <div ng-repeat="task in task.parent" style="border-radius:5px;background:rgba(250,250,250,1);position:relative;">
            <task-type type="task.type"></task-type>
            <span>{{task.title}}</span>
             <a href="{{task._id | tasklink}}" style="margin-let:0.5rem;">check</a>
        </div>
    </div>


    <!--    说明-->
    <div style="display:flex;flex-direction:row;"><button style="margin-left:auto" ng-disabled="taskUpdating" ng-click="switchAddDesc()">EDIT</button></div>
    <div style="min-height:1rem;padding:0.5rem;">
          <span ng-repeat="attach in task.attachments" class="backGrayBtn" style="padding:5px;margin-right:0.5rem;" ng-click="openAttach(attach.link,attach.name)">
              <img src="{{attach.name | linkIcon}}" style="width:1.2rem;margin-left:0.5rem;">
              <span style="max-width:6rem;">{{attach.name}}</span>
          </span>
    </div>
    <div style="margin-top:0.5rem;min-height:5rem;" ng-hide="addingDesc" id="description"><%- description %></div>


    <div ng-show="addingDesc" style="display:flex;flex-direction:column;border:solid 1px rgba(152,75,67,1);border-radius:5px;padding:1.5rem;box-shadow: 4px 0 5px -3px rgba(185,185,185,0.8);">
        <textarea style="min-height:6rem;" ng-disabled="taskUpdating" id="descriptionBox"></textarea>
        <div style="display:flex;flex-direction:row;">
            <button class="submitButton" ng-click="submitDescription()" ng-disabled="taskUpdating">保存</button>
        </div>
    </div>

    <div ng-repeat="desc in addDescription">{{desc.contents}}</div>
    <!--    End  补充说明-->


    <div style="margin:1.5rem;margin-left:0;margin-right:0;border-bottom:solid 1px rgba(205,205,205,1);"></div>


<!--    评论内容-->
    <div style="display:flex;flex-direction:column;min-height:6rem;flex:1;margin-left:1.5rem;">
        <div ng-show="comments.length === 0" style="margin:auto;color:rgba(140,140,140,0.8);font-size:2rem;">NO COMMENT NOW</div>
        <div ng-repeat="comment in comments">
            <div style="display:flex;flex-direction:row;" class="subRow" ng-if="comment.type <2">
                <div>提交人：{{comment.user.name}}</div>
                <div>提交日期：{{comment.date | date:'&y/&m/&d &h:&i:&s'}}</div>
                <div>status：{{comment.status | taskStatus}}</div>
            </div>
            <div ng-if="comment.type <2" style="min-height:1rem;padding:0.5rem;margin-left:1.5rem;"><span ng-repeat="attach in comment.attachments" class="backGrayBtn" style="padding:5px;margin-right:0.5rem;" ng-click="openAttach(attach.link,attach.name,attach)" >
              <img src="{{attach.name | linkIcon}}" style="width:1.2rem;margin-left:0.5rem;">
              <span style="max-width:6rem;">{{attach.name}}</span>
          </span></div>
            <div style="padding-left:2rem;padding-right:2rem;padding-top:0.5rem;" content-format contents="{{comment.comment}}">{{comment.comment}}</div>
            <div style="margin:1rem;border-bottom:solid 1px rgba(205,205,205,1);"></div>
        </div>
    </div>

    <div class="pageCount" style="margin-top:1rem;margin-bottom:0.5rem;" ng-show="commentPage.maxCount >0 ">
        <div ng-if="commentPage.startIndex>1"><button ng-click="goToCommentPage(1)">1</button></div>
        <div ng-if="commentPage.startIndex>2">…</div>
        <div ng-repeat="x in [].constructor(7) track by $index">
            <button ng-if="$index+commentPage.startIndex <= commentPage.page"
                    ng-click="goToCommentPage($index+ commentPage.startIndex)"
                    ng-disabled="commentPage.pageId - commentPage.startIndex === $index">{{$index+commentPage.startIndex}}</button></div>
        <div ng-if="commentPage.startIndex+7 < commentPage.pageMax">…</div>
        <div ng-if="commentPage.startIndex+7 <= commentPage.page">
            <button ng-click="goToCommentPage(commentPage.pageMax)">{{commentPage.pageMax}}</button>
        </div>
    </div>


<!--    底部新评论-->
    <div style="display:flex;flex-direction:column;padding:1.5rem;margin-top:2rem;">
        <div style="display:flex;flex-direction:row;">
            <div style="margin-left:1rem;">提交人：{{user.name}}</div>
            <div style="margin-left:4rem;">schedule：</div>
            <input ng-disabled="!updatable(1)" type="date" id="commentTime">
            <div style="margin-left:4rem;">status：</div>
            <select ng-disabled="!updatable(1)" ng-model="status">
                <option value="0">Verifying</option>
                <option value="1">Engineer Assigned</option>
                <option value="2">QA</option>
                <option value="3">Feedback </option>
                <option value="4">CLOSED</option>
                <option value="5">Pending</option>
            </select>
        </div>
        <div style="display:flex;flex-direction:row;margin-bottom:0.5rem;">
            <div style="flex:1;display:flex;flex-direction:row;flex-wrap:wrap;margin-left:2rem;">
                <span ng-repeat="attach in attachments['1']" style="margin-right:0.5rem;">
                     <img src="{{attach.name | linkIcon}}" style="width:1.2rem;margin-left:0.5rem;">
                     <span style="max-width:6rem;">{{attach.name}}</span>
                     <button  class="closeBtnInline" ng-click="deleteAttach(attach,1)"><i class="fas fa-times-circle"></i></button>
                </span>
            </div>
            <div style="display:flex;flex-direction:row;margin-left:auto;border-radius:3px; background:rgba(230,230,230,0.8);padding:0.5rem;margin-right:2rem;box-shadow: 4px 0 5px -3px rgba(185,185,185,0.8);">
                <input  id="attachUpload1" ng-disabled="!updatable(1)" style="margin-left:auto;" type=file>
                <button ng-click="uploadAttach(1,null,'comment')"  ng-disabled="!updatable(1)" style="margin-left:0.5rem;">Upload</button>
            </div>
        </div>
        <textarea style="min-height:6rem;" ng-model="comment[1]" ng-disabled="!updatable(1)"></textarea>
        <div style="display:flex;flex-direction:row;">
            <button class="submitButton" ng-click="submitComment(1)" ng-disabled="!updatable(1)" style="margin-left:auto;margin-right:3rem;">提交</button>
        </div>
    </div>
<!--   END 底部新评论-->
</div>


<!--   Cover Page-->
<div id="pageCover" class="coverLayer" style="background:rgba(58,58,58,0.4);position:fixed;display:none;" ng-controller="coverCon">
    <div id="infoBoard" class="addTask addDoc" style="position:relative;">
        <div class="addDocCover coverLayer" style="z-index:99;background:rgba(218,218,218,0.4);" ng-show="savingTask">
            <i class="fa fa-spinner fa-spin fa-3x" style="margin:auto;"></i>
        </div>
        <div style="margin:1rem;display:flex;flex-direction:column;display:none;" >
            <table id="docDetail" class="displayTable" style="flex:1;margin-top:0.5rem;">
                <tr><td colspan=2><input ng-model="newTask.title" placeholder="Task Title(mandatory)" style="min-width:30rem;" id="titleInput"></td></tr>
                <tr><td>Type:</td><td>
                    <select ng-disabled="savingTask" ng-model="newTask.type" onchange="this.size=0" onmousedown="if(this.options.length>10){this.size=10}" onblur="this.size = 0" style="position:absolute;z-index:99;">
                        <option value="0">Issue</option>
                        <option value="1">Requirement</option>
                        <option value="2">release</option>
                        <option value="3">QA</option>
                        <option ng-repeat="account in Accounts" value="account._id">{{account.name}}</option>
                    </select>
                </td></tr>
                <tr><td>Due On:</td><td><input  type="date" id="NewTaskDate" ng-model="newTask.dueOn"></td></tr>
                <tr><td>Account:</td><td>
                    <select ng-disabled="savingTask" ng-model="newTask.account" ng-change="loadProjects(target)" onchange="this.size=0" onmousedown="if(this.options.length>10){this.size=10}" onblur="this.size = 0" style="position:absolute;z-index:98;">
                        <option value="0">Please select account</option>
                        <option ng-repeat="account in accounts" value="{{account._id}}">{{account.name}}</option>
                    </select>
                </td></tr>
                <tr><td>Project:</td><td>
                    <select ng-disabled="savingTask" ng-change="loadVersions()" ng-model="newTask.project" onchange="this.size=0" onmousedown="if(this.options.length>10){this.size=10}" onblur="this.size = 0" style="position:absolute;z-index:97;">
                        <option value="0">Please select project</option>
                        <option ng-repeat="project in projects" value="{{project._id}}">{{project.name}}</option>
                    </select>
                </td></tr>
                <tr><td style="min-width:7.5rem;width:7.5rem;">Found on Version:</td><td>
                    <select ng-disabled="savingTask" ng-model="newTask.version" onmousedown="if(this.options.length>10){this.size=10}" onblur="this.size = 0" style="position:absolute;z-index:95;" onchange="this.size=0">
                        <option value="0">Please select version</option>
                        <option ng-repeat="version in versions" value="{{version._id}}">{{version | versionname}}</option>
                    </select>
                </td></tr>
                <tr><td colspan="2">
                    <textarea ng-disabled="savingTask" ng-model="newTask.description" style="min-height:8rem;min-width:30rem;border-radius:5px;"></textarea>
                </td></tr>
            </table>
            <div style="display:flex;flex-direction:row;margin-top:1rem;">
                <button style="margin-left:6rem;margin-right:auto;" ng-click="submitDoc()" ng-disabled="savingTask">提交</button>
                <button style="margin-left:auto;margin-right:6rem;" ng-click="cancelAddDoc()" ng-disabled="savingTask">取消</button>
            </div>
        </div>
        <div id="alertBoard">
            <div id="alertTaskInfo" style="margin:2rem;"></div>
            <div style="display:flex;flex-direction:row;margin-top:1rem;">
                <button style="margin-left:6rem;margin-right:auto;" ng-click="answerAlert(true)" ng-disabled="savingTask">提交</button>
                <button style="margin-left:auto;margin-right:6rem;" ng-click="answerAlert(false)" ng-disabled="savingTask">取消</button>
            </div>
        </div>
    </div>
</div>

<!--END COVER PAGE-->
</body>
</html>